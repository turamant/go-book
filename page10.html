<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static/css/main.css">
    <title>Page 3</title>
</head>
<body>
    <h1>Глава 4. Ответы, управляемые базой данных</h1>
<p>Чтобы наше веб-приложение Snippetbox стало по-настоящему полезным, нам нужно где-то хранить (или
    сохранять) данные, введенные пользователями, а также возможность динамически запрашивать это хранилище данных во время
    выполнения.</p>
<p>Существует множество различных хранилищ данных, которые мы могли бы использовать для нашего приложения — каждое со своими
    плюсами и минусами — но мы выберем популярную реляционную базу данных MySQL.
</p>
<p>В этом разделе вы узнаете, как:</p>
   <ul>
    <li>Подключаться к MySQL из вашего веб-приложения (в частности, вы узнаете, как установить пул
        многократно используемых соединений).</li>
    <li>Создайте автономный пакет моделей, чтобы логика вашей базы данных могла повторно использоваться и
        была отделена от вашего веб-приложения.</li>
    <li>Используйте соответствующие функции в пакете Go database/sql для выполнения различных типов
        операторов SQL и узнайте, как избежать распространенных ошибок, которые могут привести к
        нехватке ресурсов вашего сервера.</li>
    <li>Предотвратите атаки путем внедрения SQL-кода, правильно используя параметры-заполнители.
    </li>
    <li>Используйте транзакции, чтобы вы могли выполнять несколько операторов SQL в одном атомарном действии.
    </li>
   </ul>     

<h2>Глава 4.1.Настройка MySQL</h2>

<p>Если вы следуете инструкциям, вам необходимо установить MySQL на свой компьютер на этом этапе. Официальная
    документация MySQL содержит исчерпывающие инструкции по установке для всех
    типов операционных систем, но если вы используете Mac OS, вы сможете установить ее с помощью:</p>

<pre><code>$ brew install mysql</code></pre>
<p>Или, если вы используете дистрибутив Linux, который поддерживает apt (например, Debian и Ubuntu), вы можете
    установить его с помощью:</p>
<pre><code>$ sudo apt install mysql-server</code></pre>
<p>Во время установки MySQL вас могут попросить установить пароль для пользователя root.
    Не забудьте запомнить это, если вы; он понадобится вам на следующем шаге.</p>
<h3>Формирование базы данных</h3>
<p>После установки MySQL вы сможете подключиться к ней со своего терминала как
    пользователь root. Команда для этого зависит от установленной версии MySQL
    . Для MySQL 5.7 вы сможете подключиться, набрав следующее:
</p>
<pre><code>$ sudo mysql
    mysql></code></pre>
<p>Но если это не сработает, попробуйте вместо этого следующую команду, введя пароль
    , который вы установили во время установки.</p>
<pre><code>$ mysql -u root -p
    Enter password:
    mysql></code></pre>
<p>После подключения первое, что нам нужно сделать, это создать базу данных в MySQL для хранения всех
    данных для нашего проекта. Скопируйте и вставьте следующие команды в приглашение mysql, чтобы
    создать новую базу данных snippetbox с использованием кодировки UTF8.</p>
<pre><code>-- Create a new UTF-8 `snippetbox` database.
    CREATE DATABASE snippetbox CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
    -- Switch to using the `snippetbox` database.
    USE snippetbox;</code></pre>
<p>Затем скопируйте и вставьте следующую инструкцию SQL, чтобы создать новую таблицу фрагментов для хранения
    текстовых фрагментов для нашего приложения:</p>
<pre><code>-- Create a `snippets` table.
    CREATE TABLE snippets (
    id INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(100) NOT NULL,
    content TEXT NOT NULL,
    created DATETIME NOT NULL,
    expires DATETIME NOT NULL
    );
    -- Add an index on the created column.
    CREATE INDEX idx_snippets_created ON snippets(created);</code></pre>
<p>Каждая запись в этой таблице будет иметь целочисленное поле идентификатора, которое будет действовать как уникальный идентификатор
    для текстового фрагмента. Он также будет иметь короткий текстовый заголовок, а само содержимое фрагмента будет
    храниться в поле содержимого. Мы также сохраним некоторые метаданные о времени
    создания фрагмента и сроке его действия.</p>
<p>Давайте также добавим несколько записей-заполнителей в таблицу фрагментов (которые мы будем использовать в следующих
    нескольких главах). Я буду использовать короткие хайку в качестве содержания текстовых фрагментов, но
    на самом деле не имеет значения, что они содержат.</p>
<pre><code>-- Add some dummy records (which we'll use in the next couple of chapters).
    INSERT INTO snippets (title, content, created, expires) VALUES (
    'An old silent pond',
    'An old silent pond...\nA frog jumps into the pond,\nsplash! Silence again.\n\n– Matsuo Bashō',
    UTC_TIMESTAMP(),
    DATE_ADD(UTC_TIMESTAMP(), INTERVAL 365 DAY)
    );
    INSERT INTO snippets (title, content, created, expires) VALUES (
    'Over the wintry forest',
    'Over the wintry\nforest, winds howl in rage\nwith no leaves to blow.\n\n– Natsume Soseki',
    UTC_TIMESTAMP(),
    DATE_ADD(UTC_TIMESTAMP(), INTERVAL 365 DAY)
    );
    INSERT INTO snippets (title, content, created, expires) VALUES (
    'First autumn morning',
    'First autumn morning\nthe mirror I stare into\nshows my father''s face.\n\n– Murakami Kijo',
    UTC_TIMESTAMP(),
    DATE_ADD(UTC_TIMESTAMP(), INTERVAL 7 DAY)
    );</code></pre>

<h3>Создание нового пользователя</h3>
<p>С точки зрения безопасности не рекомендуется подключаться к MySQL в качестве пользователя root
    из веб-приложения. Вместо этого лучше создать пользователя базы данных с ограниченными
    правами доступа к базе данных.</p>
<p>Итак, пока вы все еще подключены к командной строке MySQL, выполните следующие команды, чтобы
    создать нового веб-пользователя с привилегиями SELECT и INSERT только в базе данных.</p>

<pre><code>CREATE USER 'web'@'localhost';
    GRANT SELECT, INSERT, UPDATE ON snippetbox.* TO 'web'@'localhost';
    -- Important: Make sure to swap 'pass' with a password of your own choosing.
    ALTER USER 'web'@'localhost' IDENTIFIED BY 'pass';</code></pre>
<p>Как только это будет сделано, введите exit, чтобы выйти из приглашения MySQL.</p>
<h3>Протестируйте нового пользователя.</h3>
<p>Теперь вы сможете подключиться к базе данных snippetbox в качестве веб-пользователя, используя следующую
    команду. При появлении запроса введите пароль, который вы только что установили.
</p>
<pre><code>$ mysql -D snippetbox -u web -p
    Enter password:
    mysql></code></pre>
<p>Если разрешения работают правильно, вы обнаружите, что можете
    правильно выполнять операции SELECT и INSERT в базе данных, но другие команды, такие как DROP TABLE
    и GRANT, завершатся ошибкой.</p>
<pre><code>mysql> SELECT id, title, expires FROM snippets;
    +----+------------------------+---------------------+
    | id | title | expires |
    +----+------------------------+---------------------+
    | 1 | An old silent pond | 2019-09-07 11:46:10 |
    | 2 | Over the wintry forest | 2019-09-07 11:46:10 |
    | 3 | First autumn morning | 2018-09-14 11:46:11 |
    +----+------------------------+---------------------+
    mysql> DROP TABLE snippets;
    ERROR 1142 (42000): DROP command denied to user 'web'@'localhost' for table 'snippets'</code></pre>
<h2>Глава 4.2. Установка драйвера базы данных</h2>
<p>Чтобы использовать MySQL из нашего веб-приложения Go, нам нужно установить драйвер базы данных. По сути, он
    действует как посредник, переводя команды между Go и
    самой базой данных MySQL.</p>    
<p>Вы можете найти полный список доступных драйверов на вики Go, но для нашего приложения
    мы будем использовать популярный драйвер go-sql-driver/mysql.
    Чтобы загрузить его, перейдите в каталог вашего проекта и запустите команду go get, например
</p>  
    
<pre><code>$ cd $HOME/code/snippetbox
    $ go get github.com/go-sql-driver/mysql@v1
    go: downloading github.com/go-sql-driver/mysql v1.5.0</code></pre>

<p>Обратите внимание, что мы добавляем к пути пакета постфикс @v1, чтобы указать, что мы хотим загрузить
    последнюю доступную версию пакета с номером основного выпуска 1.</p>
<p>На момент написания это версия 1.5.0, но версия, которую вы загружаете может быть v1.5.1, v1.6.0
    или аналогичный — и это нормально. Поскольку пакет go-sql-driver/mysql использует семантическое
    управление версиями для своих выпусков, любая версия v1.xx должна быть совместима с остальным кодом
    в этой книге.</p>
<p>Кроме того, если вы хотите загрузить последнюю версию, независимо от номера версии, вы
    можете просто опустить суффикс @version следующим образом:</p>

<pre><code>$ go get github.com/go-sql-driver/mysql</code></pre>
<p>Или, если вы хотите загрузить определенную версию пакета, вы можете использовать полный
    номер версии. Например:</p>
<pre><code>$ go get github.com/go-sql-driver/mysql@v1.0.3</code></pre>
<p>После установки драйвера взгляните на свой файл go.mod (который мы создали в самом
    начале книги). Вы должны увидеть новую строку require, содержащую путь к пакету и
    точную версию, которая была загружена:</p>
<pre><code>File: go.mod
    module alexedwards.net/snippetbox
    go 1.15
    require github.com/go-sql-driver/mysql v1.5.0</code></pre>

<p>Вы также увидите, что в корне каталога вашего проекта был создан новый файл с именем
    go.sum.</p>
<p><img src="static/images/pic4.1.png"/></p>
<p>Этот файл go.sum содержит криптографические контрольные суммы, представляющие содержимое
    необходимых пакетов. Если вы откроете его, вы должны увидеть что-то вроде этого:</p>
<pre><code>File: go.sum
    github.com/go-sql-driver/mysql v1.5.0 h1:ozyZYNQW3x3HtqT1jira07DN2PArx2v7/mN66gGcHOs=
    github.com/go-sql-driver/mysql v1.5.0/go.mod h1:DCzpHaOWr8IXmIStZouvnhqoel9Qv2LBy8hT2VhHyBg=</code></pre>
<p>В отличие от файла go.mod файл go.sum не предназначен для редактирования человеком, и, как правило,
    его не нужно открывать. Но он выполняет две полезные функции:</p>
<ul>
    <li>Если вы запустите команду go mod verify со своего терминала, это проверит, что контрольные
        суммы загруженных пакетов на вашем компьютере совпадают с записями в go.sum,
        поэтому вы можете быть уверены, что они не были изменены.</li>
    <li>Если кому-то еще нужно загрузить все зависимости для проекта — что он
        может сделать, запустив go mod download — он получит сообщение об ошибке, если есть какое-либо несоответствие
        между загружаемыми зависимостями и контрольными суммами в файле.</li>
</ul>

<h3>Дополнительная информация</h3>
<h4>Обновление пакетов</h4>
<p>После того, как пакет загружен и добавлен в ваш файл go.mod, пакет и
    версия становятся «фиксированными». Но есть много причин, по которым вы можете захотеть обновиться, чтобы использовать более новую
    версию пакета в будущем.</p>
<p>Чтобы обновить до последней доступной дополнительной версии или исправления пакета, вы можете просто запустить
    go get с флагом -u следующим образом:</p>

<pre><code>$ go get -u github.com/foo/bar</code></pre>
<p>Или, наоборот, если вы хотите перейти на определенную версию, вам следует запустить ту же
    команду, но с соответствующим суффиксом @version. Например:</p>
<pre><code>$ go get -u github.com/foo/bar@v2.0.0</code></pre>
<h3>Удаление неиспользуемых пакетов</h3>
<p>Иногда вы можете получить пакет только для того, чтобы позже в вашей сборке понять, что
    он вам больше не нужен. Когда это происходит, у вас есть два варианта.</p>
<p>Вы можете либо запустить go get, либо указать путь к пакету с постфиксом @none, например:</p>
<pre><code>$ go get github.com/foo/bar@none</code></pre>
<p>Или, если вы удалили все ссылки на пакет в своем коде, вы можете запустить
    go mod tidy, который автоматически удалит все неиспользуемые пакеты из ваших
    файлов go.mod и go.sum.</p>
<pre><code>$ go mod tidy -v</code></pre>

<h2>Глава 4.3. Создание пула соединений с базой данных</h2>
<p>Теперь, когда база данных MySQL настроена и у нас установлен драйвер, следующим естественным
    шагом будет подключение к базе данных из нашего веб-приложения.</p>
<p>Для этого нам понадобится функция Go sql.Open(), которую вы используете примерно так:
</p>
<pre><code>// Функция sql.Open() инициализирует новый объект sql.DB, который, по сути, является
// пулом соединений с базой данных.
    db, err := sql.Open("mysql", "web:pass@/snippetbox?parseTime=true"),
    если err != nil {
    ...
    }</code></pre>
<p>В этом коде есть несколько вещей, которые нужно объяснить и подчеркнуть:</p>
<ul>
    <li>Первый параметр sql.Open() — это имя драйвера, а второй параметр — это
        имя источника данных (иногда также называемое строкой подключения или DSN), которое описывает,
        как подключиться . в вашу базу данных.</li>
    <li>Формат имени источника данных будет зависеть от используемой базы данных и драйвера
        . Как правило, вы можете найти информацию и примеры в документации для вашего
        конкретного драйвера. Для драйвера, который мы используем, вы можете найти эту документацию здесь.</li>
    <li>Приведенная выше часть parseTime=true DSN — это параметр, специфичный для драйвера, который указывает
        нашему драйверу преобразовывать поля SQL TIME и DATE в объекты Go time.Time.</li>
    <li>Функция sql.Open() возвращает объект sql.DB. Это не соединение с базой данных — это
        пул многих соединений. Это важное различие для понимания. Go управляет
        этими соединениями по мере необходимости, автоматически открывая и закрывая соединения с
        базой данных через драйвер.</li>
    <li>Пул соединений безопасен для одновременного доступа, поэтому вы можете
        безопасно использовать его из обработчиков веб-приложений.</li>
    <li>Пул соединений предназначен для длительного использования. В веб-приложении нормально инициализировать
        пул соединений в вашей функции main(), а затем передать пул вашим
        обработчикам. Вы не должны вызывать sql.Open() в самом короткоживущем обработчике — это будет пустой
        тратой памяти и сетевых ресурсов.</li>
</ul>
<h3>Использование в нашем веб-приложении</h3>
<p>Давайте посмотрим, как использовать sql.Open() на практике. Откройте файл main.go и добавьте
    следующий код:</p>
<pre><code>Файл: cmd/web/main.go
    package main
    
    import (
        "database/sql" // Новый импорт
        "flag"
        "log"
        "net/http"
        "os"
        _ "github.com/go-sql-driver/mysql" // Новый импорт
    )
    ...
    func main() {
        addr := flag.String("addr", ":4000", "HTTP network address")
        // Определить новый флаг командной строки для строки DSN MySQL.
        dsn := flag.String("dsn", "web:pass@/snippetbox?parseTime=true", "имя источника данных MySQL") flag.Parse(
        )
        infoLog := log.New(os.Stdout, "INFO\ t", log.Ldate|log.Ltime)
        errorLog := log.New(os.Stderr, "ERROR\t", log.Ldate|log.Ltime|log.
        
        // объединение в отдельную функцию openDB() ниже. Мы передаем openDB() DSN
        // из флага командной строки.
        db, err := openDB(*dsn)
        if err != nil {
            errorLog.Fatal(err)
        }
        // Мы также откладываем вызов db.Close(), так что пул соединений закрывается
        // перед main( ) функция завершает работу.
        defer db.Close()
        app := &application{
        errorLog: errorLog,
        infoLog: infoLog,
        }
        srv := &http.Server{
        Addr: *addr,
        ErrorLog: errorLog,
        Handler: app.routes(),
        }
        infoLog.Printf(" Запуск сервера на %s", *addr)
        // Поскольку переменная err уже объявлена ​​в приведенном выше коде, нам нужно
        // использовать здесь оператор присваивания = вместо оператора := 'объявить и присвоить'
        //.
        err = srv.ListenAndServe()
        errorLog.Fatal(err)
    }
    
    // Функция openDB() оборачивает sql.Open() и возвращает пул соединений sql.DB
    // для данного DSN.
    func openDB(dsn string) (*sql.DB, error) {
        db, err := sql.Open("mysql", dsn)
        if err != nil {
            return nil, err
        }
        if err = db.Ping(); err != nil {
            return nil, err
        }
        return db, nil
    }
</code></pre>

<p>В этом коде есть несколько интересных моментов:</p>
<ul>
    <li>Обратите внимание, путь импорта для нашего драйвера начинается со знака подчеркивания? Это потому, что
        наш файл main.go на самом деле ничего не использует в пакете mysql. Поэтому, если мы попытаемся
        импортировать его в обычном режиме, компилятор Go выдаст ошибку.
        Однако нам нужно запустить функцию init() драйвера , чтобы она могла зарегистрироваться в пакете database/sql. Хитрость
        , чтобы обойти это, состоит в том, чтобы связать имя пакета с пустым идентификатором. Это
        стандартная практика для большинства SQL-драйверов Go.</li>
    <li>Функция sql.Open() на самом деле не создает никаких соединений, все, что она делает, это инициализирует
        пул для будущего использования. Фактические соединения с базой данных устанавливаются лениво, т.к.
        когда нужно в первый раз. Итак, чтобы убедиться, что все настроено правильно, нам нужно использовать
        метод db.Ping() для создания соединения и проверки на наличие ошибок.</li>
    <li>На данный момент вызов defer db.Close() немного излишен. Наше
        приложение всегда завершается прерыванием сигнала (например, Ctrl+c) или
        errorLog.Fatal(). В обоих этих случаях программа завершается немедленно, а отложенные
        функции никогда не запускаются. Но включение db.Close() — это хорошая привычка, и это может
        быть полезно позже в будущем, если вы добавите корректное завершение работы в свое приложение.</li>
</ul>
<h3>Проверка подключения</h3>
<p>Убедитесь, что файл сохранен, а затем попробуйте запустить приложение. Если все идет
    по плану, пул соединений должен быть установлен, и метод db.Ping() должен
    создать соединение без каких-либо ошибок. Если все хорошо, вы должны увидеть обычное
    сообщение Starting server… в журнале:</p>
<pre><code>$ go run ./cmd/web
    INFO 2018/09/07 13:54:19 Starting server on :4000</code></pre>
<p>Если приложение не запускается и вы получаете сообщение об ошибке «Отказано в доступе...», как показано ниже, проблема, вероятно, связана с вашим DSN. Дважды проверьте правильность имени пользователя и
    пароля, что у пользователей вашей базы данных есть правильные разрешения и что ваш
    экземпляр MySQL использует стандартные настройки.</p>

<pre><code>$ go run ./cmd/web
    ERROR 2018/09/07 13:55:51 main.go:44: Error 1045: Access denied for user 'web'@'localhost' (using password: YES)
    exit status 1</code></pre>

   <h2> Chapter 4.4.
    Designing a Database Model</h2>
........................
</body>
</html>